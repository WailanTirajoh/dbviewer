<% content_for :title do %>
  Query: <%= @table_name %>
<% end %>

<% content_for :head do %>
  <link href="https://cdn.jsdelivr.net/npm/vscode-codicons@0.0.17/dist/codicon.min.css" rel="stylesheet">
<% end %>

<% content_for :sidebar_active do %>active<% end %>

<% content_for :sidebar do %>
  <%= render 'dbviewer/shared/sidebar' %>
<% end %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Query: <%= @table_name %></h1>
  <div>
    <%= link_to table_path(@table_name), class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left me-1"></i> Back to Table
    <% end %>
  </div>
</div>
  
  <% if flash[:warning].present? %>
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <%= flash[:warning] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>
  
  <div class="card mb-4">

    <div class="monaco" style="min-height: 100px"></div>
    
    <div class="card-header">
      <h5>SQL Query (Read-Only)</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Read-Only Mode:</strong> For security reasons, only SELECT queries are allowed. Any other SQL operations (INSERT, UPDATE, DELETE, ALTER, etc.) will be rejected.
      </div>
      
      <div class="card mb-3">
        <div class="card-header">
          <h6>Table Structure Reference</h6>
        </div>
        <div class="card-body p-2">
          <% if @columns.present? %>
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-0">
                <thead>
                  <tr>
                    <th>Column</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody>
                  <% @columns.each do |column| %>
                    <tr>
                      <td><code><%= column[:name] %><%= " (PK)" if column[:primary] %></code></td>
                      <td><span class="badge bg-secondary"><%= column[:type] %></span></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p class="mb-0">No column information available.</p>
          <% end %>
        </div>
      </div>
      
      <%= form_with url: query_table_path(@table_name), method: :post, local: true do |form| %>
        <div class="mb-3">
          <%= form.text_area :query, value: @query, class: 'form-control', rows: 7, 
                placeholder: "Enter your SELECT query here...", 
                style: 'font-family: monospace; font-size: 14px;' %>
        </div>
        
        <div class="d-flex justify-content-between align-items-start">
          <div class="form-text text-muted">
            <strong>Examples:</strong><br>
            <code>SELECT * FROM <%= @table_name %> LIMIT 100</code><br>
            <code>SELECT column1, column2 FROM <%= @table_name %> WHERE column3 = 'value'</code><br>
            <code>SELECT COUNT(*) FROM <%= @table_name %> GROUP BY category</code>
          </div>
          <div>
            <%= form.submit "Run Query", class: "btn btn-primary" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  
  <% if @error.present? %>
    <div class="alert alert-danger" role="alert">
      <strong>Error:</strong> <%= @error %>
    </div>
  <% end %>
  
  <% if @records.present? %>
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5>Results</h5>
        <span class="badge bg-secondary">Rows: <%= @records.rows.count %></span>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <% if @records.columns.any? %>
              <thead>
                <tr>
                  <% @records.columns.each do |column_name| %>
                    <th><%= column_name %></th>
                  <% end %>
                </tr>
              </thead>
              <tbody>
                <% if @records.rows.any? %>
                  <% @records.rows.each do |row| %>
                    <tr>
                      <% row.each do |cell| %>
                        <td><%= format_cell_value(cell) %></td>
                      <% end %>
                    </tr>
                  <% end %>
                <% else %>
                  <tr>
                    <td colspan="<%= @records.columns.count %>">Query executed successfully, but returned no rows.</td>
                  </tr>
                <% end %>
              </tbody>
            <% else %>
              <tr>
                <td>Query executed successfully, but returned no columns.</td>
              </tr>
            <% end %>
          </table>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script type="module">
  import * as monaco from 'https://cdn.jsdelivr.net/npm/monaco-editor@0.39.0/+esm';

  monaco.editor.create(document.querySelector('.monaco'));
</script>