<% content_for :title do %>
  Table: <%= @table_name %>
<% end %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Table: <%= @table_name %></h1>
    <div>
      <%= link_to "Run SQL Query", query_database_path(@table_name), class: "btn btn-primary me-2" %>
      <%= link_to "← Back to Tables", databases_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>
  
  <div class="card mb-4">
    <div class="card-header">
      <h5>Structure</h5>
    </div>
    <div class="card-body">
      <%= render 'table_structure' %>
    </div>
  </div>
  
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5>Records</h5>
      <div class="d-flex align-items-center">
        <div class="me-3">
          <label for="per-page-select" class="me-2">Per page:</label>
          <select id="per-page-select" class="form-select form-select-sm" onchange="window.location.href='<%= database_path(@table_name) %>?per_page=' + this.value + '&page=1&order_by=<%= @order_by %>&order_direction=<%= @order_direction %>'">
            <% Dbviewer::DatabasesController.per_page_options.each do |option| %>
              <option value="<%= option %>" <%= 'selected' if @per_page == option %>><%= option %></option>
            <% end %>
          </select>
        </div>
        <span class="badge bg-secondary">Total: <%= @total_count %> records</span>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <% if @records.present? && @records.columns.any? %>
            <thead>
              <tr>
                <% @records.columns.each do |column_name| %>
                  <th>
                    <%= column_name %>
                    <div class="btn-group btn-group-sm sort-buttons">
                      <%= link_to database_path(@table_name, order_by: column_name, order_direction: 'ASC', page: @current_page, per_page: @per_page), 
                          class: "btn btn-outline-secondary btn-sm #{'active' if @order_by == column_name && @order_direction == 'ASC'}" do %>
                        <i class="bi bi-arrow-up"></i>
                      <% end %>
                      <%= link_to database_path(@table_name, order_by: column_name, order_direction: 'DESC', page: @current_page, per_page: @per_page), 
                          class: "btn btn-outline-secondary btn-sm #{'active' if @order_by == column_name && @order_direction == 'DESC'}" do %>
                        <i class="bi bi-arrow-down"></i>
                      <% end %>
                    </div>
                  </th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% @records.rows.each do |row| %>
                <tr>
                  <% row.each do |cell| %>
                    <td><%= format_cell_value(cell) %></td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          <% else %>
            <tr>
              <td colspan="100%">No records found or table is empty.</td>
            </tr>
          <% end %>
        </table>
      </div>
      
      <% if @total_pages > 1 %>
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <li class="page-item <%= 'disabled' if @current_page == 1 %>">
              <%= link_to '«', database_path(@table_name, page: [@current_page - 1, 1].max, order_by: @order_by, order_direction: @order_direction, per_page: @per_page), class: 'page-link' %>
            </li>
            
            <% start_page = [1, @current_page - 2].max %>
            <% end_page = [start_page + 4, @total_pages].min %>
            <% start_page = [1, end_page - 4].max %>
            
            <% (start_page..end_page).each do |page_num| %>
              <li class="page-item <%= 'active' if page_num == @current_page %>">
                <%= link_to page_num, database_path(@table_name, page: page_num, order_by: @order_by, order_direction: @order_direction, per_page: @per_page), class: 'page-link' %>
              </li>
            <% end %>
            
            <li class="page-item <%= 'disabled' if @current_page == @total_pages %>">
              <%= link_to '»', database_path(@table_name, page: [@current_page + 1, @total_pages].min, order_by: @order_by, order_direction: @order_direction, per_page: @per_page), class: 'page-link' %>
            </li>
          </ul>
        </nav>
      <% end %>
    </div>
  </div>
</div>
